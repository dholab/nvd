name: Container Build and Test

on:
  push:
    branches: [main, develop]
    paths:
      - 'Containerfile'
      - 'pyproject.toml'
      - 'pixi.lock'
      - 'uv.lock'
      - 'lib/**'
      - 'conf/**'
      - '.github/workflows/container-build-test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'Containerfile'
      - 'pyproject.toml'
      - 'pixi.lock'
      - 'uv.lock'
      - 'lib/**'
      - 'conf/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-docker:
    name: Test Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile
          push: false
          load: true
          tags: nvd2:test
          cache-from: |
            type=gha,scope=${{ github.ref_name }}
            type=gha,scope=main
            type=gha,scope=develop
          cache-to: type=gha,mode=max,scope=${{ github.ref_name }}
      
      - name: Verify image built
        run: |
          docker images nvd2:test
          echo "Built image: nvd2:test"
      
      - name: Test container starts
        run: |
          docker run --rm nvd2:test \
            bash -c 'echo "Container started successfully"'
      
      - name: Test PATH includes Pixi tools
        run: |
          docker run --rm nvd2:test \
            bash -c 'echo $PATH | grep /opt/.pixi/envs/default/bin || exit 1'
      
      - name: Test bioinformatics tools available
        run: |
          docker run --rm nvd2:test \
            bash -c '
              which samtools && samtools --version &&
              which blastn && blastn -version &&
              which nextflow && nextflow -version &&
              which minimap2 && minimap2 --version &&
              which seqkit && seqkit version
            '
      
      - name: Test Python environment
        run: |
          docker run --rm nvd2:test \
            bash -c '
              python --version &&
              python -c "import Bio; print(\"Bio OK\")" &&
              python -c "import pandas; print(\"pandas OK\")" &&
              python -c "import polars; print(\"polars OK\")"
            '
      
      - name: Test py_nvd package imports
        run: |
          docker run --rm nvd2:test \
            bash -c '
              echo "Testing py_nvd imports..." &&
              python -c "from py_nvd import __version__; print(f\"py_nvd version: {__version__}\")" &&
              python -c "from py_nvd.cli import app; print(\"CLI app imported successfully\")" &&
              echo "✅ All py_nvd imports successful"
            '
      
      - name: Test nvd CLI
        run: |
          docker run --rm nvd2:test \
            bash -c '
              echo "Testing nvd CLI..." &&
              nvd --help &&
              nvd version &&
              echo "✅ nvd CLI works"
            '
      
      - name: Test environment variables
        run: |
          docker run --rm nvd2:test \
            bash -c '
              [ "$NXF_CACHE_DIR" = "/scratch" ] || exit 1
              [ "$NXF_HOME" = "/scratch" ] || exit 1
              echo "Environment variables OK"
            '
