name: Container Build and Test

on:
  push:
    branches: [main, develop]
    paths:
      - 'Containerfile'
      - 'pyproject.toml'
      - 'pixi.lock'
      - 'conf/**'
      - '.github/workflows/container-build-test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'Containerfile'
      - 'pyproject.toml'
      - 'pixi.lock'
      - 'conf/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-docker:
    name: Test Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile
          push: false
          load: true
          tags: nvd2:test
          cache-from: |
            type=gha,scope=${{ github.ref_name }}
            type=gha,scope=main
            type=gha,scope=develop
          cache-to: type=gha,mode=max,scope=${{ github.ref_name }}
      
      - name: Verify image built
        run: |
          docker images nvd2:test
          echo "Built image: nvd2:test"
      
      - name: Test container starts
        run: |
          docker run --rm nvd2:test \
            bash -c 'echo "Container started successfully"'
      
      - name: Test PATH includes Pixi tools
        run: |
          docker run --rm nvd2:test \
            bash -c 'echo $PATH | grep /opt/.pixi/envs/default/bin || exit 1'
      
      - name: Test bioinformatics tools available
        run: |
          docker run --rm nvd2:test \
            bash -c '
              which samtools && samtools --version &&
              which blastn && blastn -version &&
              which nextflow && nextflow -version &&
              which minimap2 && minimap2 --version &&
              which seqkit && seqkit version
            '
      
      - name: Test Python environment
        run: |
          docker run --rm nvd2:test \
            bash -c '
              python --version &&
              python -c "import Bio; print(\"Bio OK\")" &&
              python -c "import pandas; print(\"pandas OK\")" &&
              python -c "import polars; print(\"polars OK\")"
            '
      
      - name: Test environment variables
        run: |
          docker run --rm nvd2:test \
            bash -c '
              [ "$NXF_CACHE_DIR" = "/scratch" ] || exit 1
              [ "$NXF_HOME" = "/scratch" ] || exit 1
              echo "Environment variables OK"
            '

  test-apptainer:
    name: Test Apptainer Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile
          push: false
          load: true
          tags: nvd2:test
          cache-from: |
            type=gha,scope=${{ github.ref_name }}-apptainer
            type=gha,scope=main-apptainer
            type=gha,scope=develop-apptainer
          cache-to: type=gha,mode=max,scope=${{ github.ref_name }}-apptainer
      
      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          cd /tmp
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.0/apptainer_1.3.0_amd64.deb
          sudo apt-get install -y ./apptainer_1.3.0_amd64.deb
          apptainer --version
      
      - name: Convert Docker image to SIF
        run: |
          sudo apptainer build nvd2.sif docker-daemon://nvd2:test
          ls -lh nvd2.sif
      
      - name: Test SIF container starts
        run: |
          apptainer exec nvd2.sif bash -c 'echo "Apptainer container OK"'
      
      - name: Test PATH in Apptainer (CRITICAL TEST)
        run: |
          echo "Testing PATH includes Pixi tools..."
          apptainer exec nvd2.sif bash -c 'echo $PATH'
          apptainer exec nvd2.sif bash -c 'echo $PATH | grep /opt/.pixi/envs/default/bin' || {
            echo "ERROR: PATH does not include /opt/.pixi/envs/default/bin"
            echo "This means the Containerfile fix did not work!"
            exit 1
          }
      
      - name: Test tools available in Apptainer
        run: |
          echo "Testing bioinformatics tools..."
          apptainer exec nvd2.sif which samtools
          apptainer exec nvd2.sif samtools --version
          apptainer exec nvd2.sif which blastn
          apptainer exec nvd2.sif blastn -version
          apptainer exec nvd2.sif which nextflow
          apptainer exec nvd2.sif nextflow -version
          apptainer exec nvd2.sif which minimap2
          apptainer exec nvd2.sif which seqkit
      
      - name: Test Python in Apptainer
        run: |
          apptainer exec nvd2.sif python --version
          apptainer exec nvd2.sif python -c "import Bio; print('Bio OK')"
          apptainer exec nvd2.sif python -c "import pandas; print('pandas OK')"
      
      - name: Test environment variables in Apptainer
        run: |
          apptainer exec nvd2.sif bash -c '
            [ "$NXF_CACHE_DIR" = "/scratch" ] || exit 1
            [ "$NXF_HOME" = "/scratch" ] || exit 1
            echo "Environment variables OK"
          '
      

