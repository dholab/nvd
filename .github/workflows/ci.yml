name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-cli-coverage:
    name: Validate CLI Parameter Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
      
      - name: Set up Python
        run: uv python install 3.10
      
      - name: Install dependencies
        run: uv sync
      
      - name: Check parameter coverage
        id: coverage_check
        run: |
          # Run validation and capture output
          if uv run nvd validate params --strict > coverage_output.txt 2>&1; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "exit_code=0" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "exit_code=1" >> $GITHUB_OUTPUT
          fi
          
          # Display output
          cat coverage_output.txt
        continue-on-error: true
      
      - name: Comment on PR (if failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('coverage_output.txt', 'utf8');
            
            const comment = `## ❌ CLI Parameter Coverage Check Failed
            
            The CLI wrapper does not cover all configurable parameters in \`nextflow.config\`.
            
            **Run locally to see details:**
            \`\`\`bash
            uv run nvd validate params --verbose
            \`\`\`
            
            <details>
            <summary>Coverage Report</summary>
            
            \`\`\`
            ${output}
            \`\`\`
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Fail if coverage incomplete
        if: steps.coverage_check.outputs.exit_code == '1'
        run: |
          echo "::error::CLI parameter coverage is incomplete. Run 'nvd validate params --verbose' locally for details."
          exit 1
      
      - name: Success message
        if: steps.coverage_check.outputs.status == 'passed'
        run: |
          echo "✅ All configurable Nextflow parameters are covered by CLI options!"

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
      
      - name: Set up Python
        run: uv python install 3.10
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run ruff check
        run: uv run ruff check bin/
      
      - name: Run ruff format check
        run: uv run ruff format --check bin/
